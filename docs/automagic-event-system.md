# Automagic Event System

The Babelfish Looking Glass system now includes an **automagic event handling system** that automatically discovers, processes, and exposes new UniFi Protect event types and fields without requiring code changes.

## Overview

When UniFi Protect introduces new event types (like `smartAudioDetect`) or new fields in existing events, the system automatically:

1. **Discovers** new event types and fields
2. **Processes** them through the analytics pipeline
3. **Exposes** them in the dashboard and API
4. **Generates** rules and flows automatically
5. **Logs** discoveries for monitoring

## How It Works

### 1. Event Discovery (Connector Level)

The `UnifiProtectConnector` automatically detects new event types and fields:

```javascript
// Automatically discovers new event types
discoverNewEventTypes(item) {
  if (!this.discoveredEventTypes.has(item.type)) {
    this.discoveredEventTypes.add(item.type);
    this.logger.warn(`ðŸ†• NEW EVENT TYPE DISCOVERED: ${item.type}`);
    this.emit('eventType:discovered', { eventType: item.type, ... });
  }
}

// Automatically discovers new fields
discoverNewFields(item) {
  for (const [key, value] of Object.entries(item)) {
    if (!knownFields.has(key)) {
      knownFields.add(key);
      this.logger.warn(`ðŸ†• NEW FIELDS DISCOVERED: ${key}`);
      this.emit('fields:discovered', { eventType: item.type, newFields: [...] });
    }
  }
}
```

### 2. Generic Event Processing (Analytics Level)

The `AnalyticsEngine` processes unknown event types generically:

```javascript
async processGenericEvent(event) {
  const { cameraId, data, timestamp, type } = event;
  
  // Store generic event data
  analytics.genericEvents.push({
    type,
    data,
    timestamp,
    processedAt: new Date().toISOString()
  });
  
  // Extract capabilities from event data
  const capabilities = this.extractCapabilitiesFromEvent(type, data);
  
  // Emit for downstream processing
  this.emit('event:generic:processed', { cameraId, eventType: type, ... });
}
```

### 3. Automatic Rule Generation (Flow Level)

The `FlowOrchestrator` automatically creates rules for new event types:

```javascript
autoGenerateRuleForEventType(eventType, sampleData) {
  const rule = {
    id: `auto-${eventType}-rule`,
    name: `Auto-generated ${eventType} Rule`,
    conditions: { eventType: eventType, source: 'communications-van' },
    actions: [
      { type: 'log_event', parameters: { ... } },
      { type: 'mqtt_publish', parameters: { ... } }
    ],
    metadata: { autoGenerated: true, eventType }
  };
  
  this.ruleEngine.registerRule(rule);
}
```

### 4. Dynamic Dashboard Updates (UI Level)

The `DashboardService` automatically displays new event types and fields:

```javascript
handleNewEventTypeDiscovered(data) {
  // Create alert for new event type
  const alert = {
    type: 'new-event-type',
    title: `New Event Type: ${data.eventType}`,
    message: `A new event type "${data.eventType}" has been discovered`
  };
  
  this.addAlert(alert);
  this.updateAnalytics(); // Refresh dashboard
}
```

## API Endpoints

### Discovered Data
```http
GET /api/discovered
```

Returns all discovered event types, fields, and auto-generated rules:

```json
{
  "success": true,
  "data": {
    "eventTypes": ["smartAudioDetect", "smartDetectLine"],
    "fields": {
      "smartAudioDetect": ["alrmBark", "duration"],
      "smartDetectLine": ["license", "crossingDirection"]
    },
    "capabilities": ["audioDetection", "licensePlateDetection"],
    "autoGeneratedRules": [...]
  }
}
```

### Generic Event Analytics
```http
GET /api/analytics/generic-events?cameraId=camera-123
```

Returns analytics for unknown event types:

```json
{
  "success": true,
  "data": {
    "totalEvents": 15,
    "eventTypes": ["smartAudioDetect", "unknownType"],
    "recentEvents": [...],
    "capabilities": ["audioDetection"],
    "discoveredFields": {...}
  }
}
```

### Auto-Generated Rules
```http
GET /api/rules/auto-generated
```

Returns all automatically generated rules:

```json
{
  "success": true,
  "data": [
    {
      "id": "auto-smartAudioDetect-rule",
      "name": "Auto-generated smartAudioDetect Rule",
      "metadata": {
        "autoGenerated": true,
        "eventType": "smartAudioDetect",
        "createdAt": "2024-01-15T10:30:00.000Z"
      }
    }
  ]
}
```

## Event Types Automatically Handled

### Smart Detection Events
- `smartDetectZone` - Zone-based smart detection
- `smartDetectLine` - Line crossing detection
- `smartAudioDetect` - Audio-based detection (NEW!)

### Motion Events
- `motion` - Basic motion detection

### System Events
- `ring` - Doorbell rings
- `recording` - Recording events
- `connection` - Connection status

### Generic Events
Any unknown event type is automatically processed as a generic event.

## Capabilities Automatically Extracted

### Smart Detection Capabilities
- `smartDetect:person` - Person detection
- `smartDetect:vehicle` - Vehicle detection
- `smartDetect:animal` - Animal detection
- `smartDetect:license` - License plate detection
- `smartDetect:alrmBark` - Audio alarm detection

### Detection Types
- `zoneDetection` - Zone-based detection
- `lineCrossing` - Line crossing detection
- `audioDetection` - Audio-based detection
- `motionDetection` - Motion detection

## MQTT Topics

### Discovery Events
- `system/discovered/eventType` - New event type discovered
- `system/discovered/fields` - New fields discovered

### Generic Events
- `events/generic` - Generic event processing

### Auto-Generated Rules
- `unifi/events/{eventType}` - Auto-generated rule events

## Monitoring and Alerts

### Discovery Alerts
The system automatically creates alerts when new event types or fields are discovered:

- **New Event Type Alert**: `ðŸ†• NEW EVENT TYPE DISCOVERED: smartAudioDetect`
- **New Fields Alert**: `ðŸ†• NEW FIELDS DISCOVERED for smartAudioDetect: alrmBark, duration`

### Log Messages
- `info`: Generic event processing
- `warn`: New discoveries
- `debug`: Field extraction and capability mapping

## Configuration

### Enable/Disable Auto-Discovery
```javascript
// In connector config
{
  "autoDiscovery": {
    "enabled": true,
    "logDiscoveries": true,
    "autoGenerateRules": true
  }
}
```

### Discovery Retention
```javascript
// In analytics config
{
  "genericEvents": {
    "retentionHours": 24,
    "maxEvents": 100
  }
}
```

## Benefits

1. **Zero Downtime**: New UniFi Protect features work immediately
2. **Automatic Processing**: No manual configuration required
3. **Full Visibility**: All new fields and types are exposed in UI/API
4. **Rule Generation**: Automatic rule creation for new event types
5. **Monitoring**: Clear alerts when new capabilities are discovered

## Example: New Audio Detection

When UniFi Protect adds audio detection:

1. **Discovery**: System detects `smartAudioDetect` event type
2. **Processing**: Audio events are processed through analytics
3. **Exposure**: Audio analytics appear in dashboard
4. **Rules**: Auto-generated rule for audio events
5. **API**: Audio endpoints become available
6. **Alerts**: Notification of new audio capability

The entire process happens automatically without any code changes!

## Troubleshooting

### Check Discovery Status
```bash
curl http://localhost:3000/api/discovered
```

### View Auto-Generated Rules
```bash
curl http://localhost:3000/api/rules/auto-generated
```

### Monitor Logs
```bash
tail -f logs/babelfish.log | grep "ðŸ†•"
```

### Reset Discoveries
```javascript
// Clear discovered data (for testing)
connector.discoveredEventTypes.clear();
connector.discoveredFields.clear();
```
